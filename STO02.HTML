<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STO Transfer Tracker</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getDatabase, ref, push, set, remove, onValue, query, orderByChild } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
    
    // Make Firebase functions available globally
    window.firebaseModules = { initializeApp, getDatabase, ref, push, set, remove, onValue, query, orderByChild };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Space Grotesk', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%); }
    .card-glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
    .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
    .btn-primary:hover { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
    .input-focus:focus { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade { animation: fadeIn 0.3s ease-out; }
    .toast { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
  <style>body { box-sizing: border-box; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full gradient-bg overflow-auto">
   <!-- Toast Container -->
   <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div><!-- Navigation -->
   <nav class="bg-white/10 backdrop-blur-md border-b border-white/20 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
     <h1 id="nav-title" class="text-xl font-bold text-white">STO Transfer Tracker</h1>
     <div class="flex gap-2">
      <button id="nav-entry-btn" onclick="showView('entry')" class="px-4 py-2 rounded-lg text-white bg-white/20 hover:bg-white/30 transition font-medium">New Entry</button> <button id="nav-admin-btn" onclick="showView('admin')" class="px-4 py-2 rounded-lg text-white bg-white/20 hover:bg-white/30 transition font-medium">Admin Panel</button>
     </div>
    </div>
   </nav><!-- Entry View -->
   <div id="entry-view" class="max-w-2xl mx-auto p-6 animate-fade">
    <div class="card-glass rounded-2xl shadow-2xl p-8">
     <div class="text-center mb-8">
      <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl flex items-center justify-center mx-auto mb-4">
       <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
       </svg>
      </div>
      <h2 id="entry-title" class="text-2xl font-bold text-gray-800">Store Transfer Entry</h2>
      <p id="company-subtitle" class="text-gray-500 mt-1">Retail Operations</p>
     </div>
     <form id="sto-form" class="space-y-5">
      <div>
       <label class="block text-sm font-semibold text-gray-700 mb-2">Employee Number *</label> <input type="text" id="employee-number" required placeholder="e.g., 31270" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl input-focus focus:border-blue-500 focus:outline-none transition">
      </div>
      <div>
       <label class="block text-sm font-semibold text-gray-700 mb-2">Employee Name *</label> <input type="text" id="employee-name" required placeholder="e.g., SUFAIJ" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl input-focus focus:border-blue-500 focus:outline-none transition">
      </div>
      <div>
       <label class="block text-sm font-semibold text-gray-700 mb-2">STO Number *</label> <input type="text" id="sto-number" required placeholder="Enter STO number (e.g., STO-2024-001)" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl input-focus focus:border-blue-500 focus:outline-none transition">
      </div>
      <div>
       <label class="block text-sm font-semibold text-gray-700 mb-2">Email Subject *</label> <textarea id="email-subject" required placeholder="Paste the email subject here..." rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl input-focus focus:border-blue-500 focus:outline-none transition resize-none"></textarea>
      </div><button type="submit" id="submit-btn" class="w-full btn-primary text-white font-semibold py-4 rounded-xl transition transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
       </svg> Submit STO Entry </button>
     </form>
     <div id="entry-loading" class="hidden text-center py-4">
      <div class="inline-block w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
      <p class="text-gray-500 mt-2">Submitting...</p>
     </div>
    </div>
   </div><!-- Admin View -->
   <div id="admin-view" class="hidden max-w-6xl mx-auto p-6 animate-fade">
    <!-- Login Panel -->
    <div id="admin-login" class="max-w-md mx-auto">
     <div class="card-glass rounded-2xl shadow-2xl p-8">
      <div class="text-center mb-6">
       <div class="w-16 h-16 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
        </svg>
       </div>
       <h2 class="text-2xl font-bold text-gray-800">Admin Login</h2>
       <p class="text-gray-500 mt-1">Enter password to access admin panel</p>
      </div>
      <form id="login-form" class="space-y-4">
       <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Admin Password</label> <input type="password" id="admin-password" required placeholder="Enter admin password" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl input-focus focus:border-amber-500 focus:outline-none transition">
       </div>
       <div id="login-error" class="hidden text-red-500 text-sm text-center"></div><button type="submit" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-semibold py-3 rounded-xl transition">Access Admin Panel</button>
      </form>
      <div class="mt-4 p-3 bg-blue-50 rounded-lg">
       <p class="text-xs text-blue-600 text-center">Default password: <strong>admin123</strong></p>
      </div>
     </div>
    </div><!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden space-y-6">
     <!-- Admin Header -->
     <div class="card-glass rounded-2xl p-6 flex justify-between items-center">
      <div>
       <h2 class="text-2xl font-bold text-gray-800">Admin Dashboard</h2>
       <p class="text-gray-500">View and manage STO reports</p>
      </div><button onclick="logoutAdmin()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 font-medium transition">Logout</button>
     </div><!-- Tabs -->
     <div class="flex gap-2">
      <button onclick="showAdminTab('reports')" id="tab-reports" class="px-6 py-3 rounded-xl font-semibold transition bg-white text-blue-600 shadow-lg">üìä STO Reports</button> <button onclick="showAdminTab('settings')" id="tab-settings" class="px-6 py-3 rounded-xl font-semibold transition bg-white/50 text-gray-600 hover:bg-white/80">‚öôÔ∏è Settings</button>
     </div><!-- Reports Tab -->
     <div id="panel-reports" class="card-glass rounded-2xl p-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-xl font-bold text-gray-800">STO Transfer Records</h3>
       <div class="flex gap-3">
        <input type="text" id="search-input" placeholder="Search STO or employee..." class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" onkeyup="filterRecords()"> <button onclick="exportToCSV()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition flex items-center gap-2">
         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
         </svg> Export CSV </button>
       </div>
      </div>
      <div id="stats-bar" class="grid grid-cols-3 gap-4 mb-6">
       <div class="bg-blue-50 rounded-xl p-4 text-center">
        <p class="text-3xl font-bold text-blue-600" id="total-transfers">0</p>
        <p class="text-sm text-gray-600">Total Transfers</p>
       </div>
       <div class="bg-green-50 rounded-xl p-4 text-center">
        <p class="text-3xl font-bold text-green-600" id="today-transfers">0</p>
        <p class="text-sm text-gray-600">Today's Transfers</p>
       </div>
       <div class="bg-purple-50 rounded-xl p-4 text-center">
        <p class="text-3xl font-bold text-purple-600" id="unique-employees">0</p>
        <p class="text-sm text-gray-600">Active Employees</p>
       </div>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead>
         <tr class="border-b-2 border-gray-200">
          <th class="text-left py-3 px-4 font-semibold text-gray-700">STO Number</th>
          <th class="text-left py-3 px-4 font-semibold text-gray-700">Employee #</th>
          <th class="text-left py-3 px-4 font-semibold text-gray-700">Employee Name</th>
          <th class="text-left py-3 px-4 font-semibold text-gray-700">Email Subject</th>
          <th class="text-left py-3 px-4 font-semibold text-gray-700">Date/Time</th>
          <th class="text-left py-3 px-4 font-semibold text-gray-700">Actions</th>
         </tr>
        </thead>
        <tbody id="records-table">
         <tr>
          <td colspan="6" class="text-center py-8 text-gray-400">No records found</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div><!-- Settings Tab -->
     <div id="panel-settings" class="hidden card-glass rounded-2xl p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Admin Settings</h3>
      <form id="settings-form" class="max-w-md space-y-4">
       <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Change Admin Password</label> <input type="password" id="new-admin-password" placeholder="New password (min 6 characters)" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
       </div>
       <div>
        <input type="password" id="confirm-admin-password" placeholder="Confirm new password" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
       </div><button type="submit" class="px-6 py-3 btn-primary text-white rounded-xl font-semibold">Update Password</button>
      </form>
      <div class="mt-8 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
       <h4 class="font-semibold text-yellow-800 mb-2">Firebase Configuration</h4>
       <p class="text-sm text-yellow-700 mb-2">To enable real-time database sync with Firebase:</p>
       <ol class="text-xs text-yellow-700 list-decimal list-inside space-y-1">
        <li>Create a Firebase project at <strong>console.firebase.google.com</strong></li>
        <li>Enable Realtime Database</li>
        <li>Get your credentials from Project Settings</li>
        <li>Update the firebaseConfig in the code with your credentials</li>
       </ol>
      </div>
     </div>
    </div>
   </div><!-- Delete Confirmation Modal -->
   <div id="delete-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="card-glass rounded-2xl p-6 max-w-sm mx-4 animate-fade">
     <h3 class="text-lg font-bold text-gray-800 mb-2">Confirm Delete</h3>
     <p class="text-gray-600 mb-4">Are you sure you want to delete this record? This action cannot be undone.</p>
     <div class="flex gap-3">
      <button onclick="confirmDelete()" class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium">Delete</button> <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium">Cancel</button>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCAU3qP2mHx41ud6LQfTimi47shNzDCcqM",
      authDomain: "saco-sto.firebaseapp.com",
      projectId: "saco-sto",
      databaseURL: "https://saco-sto-default-rtdb.asia-southeast1.firebasedatabase.app",
      storageBucket: "saco-sto.firebasestorage.app",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:3d941614208d6a18a30b19"
    };

    // Initialize Firebase
    let firebase_initialized = false;
    let db = null;
    
    async function initFirebase() {
      try {
        const { initializeApp, getDatabase } = window.firebaseModules;
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        firebase_initialized = true;
        loadRecordsFromFirebase();
      } catch (error) {
        console.error('Firebase initialization error:', error);
        firebase_initialized = false;
      }
    }
    
    // Wait for Firebase modules to load
    setTimeout(initFirebase, 1000);

    // Data Handler - Firebase only
    let allData = [];
    let stoRecords = [];
    let isAdminLoggedIn = false;
    let adminPassword = 'admin123';
    let deleteTarget = null;
    let currentRecordCount = 0;

    function loadRecordsFromFirebase() {
      if (!firebase_initialized || !db) {
        console.log('Firebase not ready');
        return;
      }

      try {
        const { ref, onValue } = window.firebaseModules;
        const recordsRef = ref(db, 'sto_transfers');
        
        onValue(recordsRef, (snapshot) => {
          allData = [];
          const data = snapshot.val();
          
          if (data) {
            Object.keys(data).forEach(key => {
              allData.push({
                ...data[key],
                __backendId: key
              });
            });
          }
          
          currentRecordCount = allData.length;
          stoRecords = allData.filter(d => d.sto_number);
          
          const passwordRecord = allData.find(d => d.type === 'admin_password');
          if (passwordRecord) {
            adminPassword = passwordRecord.password;
          }
          
          updateStats();
          renderRecordsTable();
        });
      } catch (error) {
        console.error('Error loading Firebase records:', error);
      }
    }

    // Toast notifications
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast px-4 py-3 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'} text-white font-medium`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // View management
    function showView(view) {
      document.getElementById('entry-view').classList.toggle('hidden', view !== 'entry');
      document.getElementById('admin-view').classList.toggle('hidden', view !== 'admin');
      
      document.getElementById('nav-entry-btn').classList.toggle('bg-white/40', view === 'entry');
      document.getElementById('nav-admin-btn').classList.toggle('bg-white/40', view === 'admin');
      
      if (view === 'admin' && !isAdminLoggedIn) {
        document.getElementById('admin-login').classList.remove('hidden');
        document.getElementById('admin-dashboard').classList.add('hidden');
      }
    }

    // Admin tabs
    function showAdminTab(tab) {
      ['reports', 'settings'].forEach(t => {
        document.getElementById(`panel-${t}`).classList.toggle('hidden', t !== tab);
        document.getElementById(`tab-${t}`).classList.toggle('bg-white', t === tab);
        document.getElementById(`tab-${t}`).classList.toggle('text-blue-600', t === tab);
        document.getElementById(`tab-${t}`).classList.toggle('shadow-lg', t === tab);
        document.getElementById(`tab-${t}`).classList.toggle('bg-white/50', t !== tab);
        document.getElementById(`tab-${t}`).classList.toggle('text-gray-600', t !== tab);
      });
    }

    // STO Form submission
    document.getElementById('sto-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (currentRecordCount >= 999) {
        showToast('Maximum record limit reached (999). Please contact admin.', 'error');
        return;
      }
      
      const submitBtn = document.getElementById('submit-btn');
      const loadingEl = document.getElementById('entry-loading');
      
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-50');
      loadingEl.classList.remove('hidden');
      
      const record = {
        sto_number: document.getElementById('sto-number').value.trim(),
        employee_number: document.getElementById('employee-number').value.trim(),
        employee_name: document.getElementById('employee-name').value.trim(),
        email_subject: document.getElementById('email-subject').value.trim(),
        created_at: new Date().toISOString()
      };
      
      // Save to Firebase only
      if (firebase_initialized && db) {
        try {
          const { ref, push } = window.firebaseModules;
          const recordsRef = ref(db, 'sto_transfers');
          await push(recordsRef, record);
          
          showToast('‚úì STO entry submitted successfully!');
          document.getElementById('sto-form').reset();
        } catch (firebaseError) {
          console.error('Firebase save error:', firebaseError);
          showToast('Failed to submit entry. Please try again.', 'error');
        }
      } else {
        showToast('Firebase not connected. Please wait and try again.', 'error');
      }
      
      submitBtn.disabled = false;
      submitBtn.classList.remove('opacity-50');
      loadingEl.classList.add('hidden');
    });

    // Admin login
    document.getElementById('login-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const password = document.getElementById('admin-password').value;
      
      if (password === adminPassword) {
        isAdminLoggedIn = true;
        document.getElementById('admin-login').classList.add('hidden');
        document.getElementById('admin-dashboard').classList.remove('hidden');
        document.getElementById('admin-password').value = '';
        document.getElementById('login-error').classList.add('hidden');
      } else {
        document.getElementById('login-error').textContent = 'Invalid password. Please try again.';
        document.getElementById('login-error').classList.remove('hidden');
      }
    });

    function logoutAdmin() {
      isAdminLoggedIn = false;
      document.getElementById('admin-login').classList.remove('hidden');
      document.getElementById('admin-dashboard').classList.add('hidden');
      showView('entry');
    }

    // Stats update
    function updateStats() {
      const today = new Date().toDateString();
      const todayRecords = stoRecords.filter(r => new Date(r.created_at).toDateString() === today);
      const uniqueEmployees = [...new Set(stoRecords.map(r => r.employee_number))];
      
      document.getElementById('total-transfers').textContent = stoRecords.length;
      document.getElementById('today-transfers').textContent = todayRecords.length;
      document.getElementById('unique-employees').textContent = uniqueEmployees.length;
    }

    // Render records table
    function renderRecordsTable() {
      const tbody = document.getElementById('records-table');
      const searchTerm = document.getElementById('search-input')?.value?.toLowerCase() || '';
      
      const filtered = stoRecords.filter(r => 
        (r.sto_number && r.sto_number.toLowerCase().includes(searchTerm)) || 
        (r.employee_number && r.employee_number.toLowerCase().includes(searchTerm)) ||
        (r.employee_name && r.employee_name.toLowerCase().includes(searchTerm)) ||
        (r.email_subject && r.email_subject.toLowerCase().includes(searchTerm))
      ).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">No records found</td></tr>';
        return;
      }
      
      tbody.innerHTML = filtered.map(record => `
        <tr class="border-b border-gray-100 hover:bg-gray-50 transition" data-id="${record.__backendId}">
          <td class="py-3 px-4 font-medium text-blue-600">${escapeHtml(record.sto_number)}</td>
          <td class="py-3 px-4">${escapeHtml(record.employee_number)}</td>
          <td class="py-3 px-4">${escapeHtml(record.employee_name)}</td>
          <td class="py-3 px-4 max-w-xs truncate" title="${escapeHtml(record.email_subject)}">${escapeHtml(record.email_subject)}</td>
          <td class="py-3 px-4 text-gray-500 text-sm">${formatDate(record.created_at)}</td>
          <td class="py-3 px-4">
            <button onclick="openDeleteModal('${record.__backendId}')" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg text-sm font-medium transition">
              Delete
            </button>
          </td>
        </tr>
      `).join('');
    }

    function filterRecords() {
      renderRecordsTable();
    }

    // Delete functionality
    function openDeleteModal(id) {
      deleteTarget = id;
      document.getElementById('delete-modal').classList.remove('hidden');
    }

    function closeDeleteModal() {
      deleteTarget = null;
      document.getElementById('delete-modal').classList.add('hidden');
    }

    async function confirmDelete() {
      if (!deleteTarget) return;
      
      const record = allData.find(d => d.__backendId === deleteTarget);
      if (!record) {
        showToast('Record not found.', 'error');
        closeDeleteModal();
        return;
      }
      
      try {
        const { ref, remove } = window.firebaseModules;
        const recordRef = ref(db, `sto_transfers/${deleteTarget}`);
        await remove(recordRef);
        showToast('Record deleted successfully!');
      } catch (error) {
        console.error('Delete error:', error);
        showToast('Failed to delete record.', 'error');
      }
      
      closeDeleteModal();
    }

    // Settings - Change password
    document.getElementById('settings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newPass = document.getElementById('new-admin-password').value;
      const confirmPass = document.getElementById('confirm-admin-password').value;
      
      if (newPass.length < 6) {
        showToast('Password must be at least 6 characters.', 'error');
        return;
      }
      
      if (newPass !== confirmPass) {
        showToast('Passwords do not match.', 'error');
        return;
      }
      
      try {
        const { ref, set, push } = window.firebaseModules;
        const existingPassRecord = allData.find(d => d.type === 'admin_password');
        
        if (existingPassRecord) {
          const recordRef = ref(db, `sto_transfers/${existingPassRecord.__backendId}`);
          await set(recordRef, { ...existingPassRecord, password: newPass });
        } else {
          const recordsRef = ref(db, 'sto_transfers');
          await push(recordsRef, {
            type: 'admin_password',
            password: newPass,
            sto_number: '',
            employee_number: '',
            employee_name: '',
            email_subject: '',
            created_at: new Date().toISOString()
          });
        }
        
        adminPassword = newPass;
        showToast('Password updated successfully!');
        document.getElementById('settings-form').reset();
      } catch (error) {
        console.error('Password update error:', error);
        showToast('Failed to update password.', 'error');
      }
    });

    // Export to CSV
    function exportToCSV() {
      if (stoRecords.length === 0) {
        showToast('No records to export.', 'error');
        return;
      }
      
      const headers = ['STO Number', 'Employee Number', 'Employee Name', 'Email Subject', 'Date/Time'];
      const rows = stoRecords.map(r => [
        r.sto_number,
        r.employee_number,
        r.employee_name,
        r.email_subject,
        formatDate(r.created_at)
      ]);
      
      const csvContent = [headers, ...rows]
        .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
        .join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `STO_Report_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      URL.revokeObjectURL(url);
      
      showToast('CSV exported successfully!');
    }

    // Utility functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      try {
        return new Date(dateStr).toLocaleString();
      } catch {
        return dateStr;
      }
    }

    // Initialize view
    showView('entry');
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d473e7a333f791d',t:'MTc3MjE5MDcxNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>